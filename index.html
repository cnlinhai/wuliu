<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>å¿«é€’è½¬è¿ Â· æŠ˜å å¯†ç å¢å¼ºç‰ˆ</title>
    <style>
        /* ----- å®Œæ•´æ ·å¼ï¼ˆä¸ä¹‹å‰ä¸€è‡´ï¼Œæ— éœ€æ”¹åŠ¨ï¼‰----- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f2f7fb;
            color: #1e2e3e;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: #0a3b4e;
            border-left: 6px solid #2a9d8f;
            padding-left: 16px;
        }
        h1 span {
            background: #2a9d8f;
            color: white;
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 30px;
            font-weight: 600;
        }
        h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f4b5c;
        }
        .card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            padding: 22px 20px;
            margin-bottom: 20px;
            border: 1px solid #eaf0f3;
        }
        details.manage-details summary {
            list-style: none;
            cursor: pointer;
            outline: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.3rem;
            font-weight: 600;
            color: #0f4b5c;
        }
        details.manage-details summary::-webkit-details-marker {
            display: none;
        }
        details.manage-details summary::after {
            content: "â–¼";
            font-size: 1.2rem;
            color: #2a9d8f;
            transition: transform 0.2s;
            margin-left: 8px;
        }
        details.manage-details[open] summary::after {
            content: "â–²";
        }
        details.manage-details[open] .manage-content {
            margin-top: 20px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: white;
            border: 1px solid #cbd8e0;
            padding: 14px 22px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1rem;
            color: #134e5e;
            background: #f9fdff;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            line-height: 1;
            white-space: nowrap;
        }
        .btn-primary {
            background: #0f3b5e;
            color: white;
            border: none;
            background: linear-gradient(145deg, #1a5a6e, #0e485a);
            box-shadow: 0 6px 12px rgba(13,79,88,0.2);
        }
        .btn-outline {
            border: 1.5px solid #2a9d8f;
            color: #2a9d8f;
            background: white;
        }
        .btn-sm {
            padding: 10px 18px;
            font-size: 0.9rem;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-bottom: 24px;
        }
        .btn-group .btn {
            flex: 1 0 calc(50% - 14px);
            white-space: normal;
            word-break: break-word;
        }
        .file-input {
            display: none;
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f6fbfd;
            padding: 22px 18px;
            border-radius: 24px;
            margin-bottom: 8px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .input-group label {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #436c7a;
            margin-left: 6px;
        }
        input, select {
            width: 100%;
            padding: 16px 18px;
            border: 1.5px solid #d4e2ea;
            border-radius: 30px;
            font-size: 1rem;
            background: white;
            transition: 0.2s;
            outline: none;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        input:focus, select:focus {
            border-color: #2a9d8f;
            box-shadow: 0 0 0 4px rgba(42,157,143,0.12);
        }
        .query-area {
            background: #eaf5f3;
            border-radius: 28px;
            padding: 22px 18px;
        }
        .select-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }
        .select-row select {
            width: 100%;
        }
        .select-row .btn {
            width: 100%;
            margin-top: 6px;
            padding: 16px;
        }
        .manual-row {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed #bcd4db;
        }
        .manual-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1d6f64;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .manual-title::before {
            content: "âœï¸";
            font-size: 1.2rem;
        }
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .input-row input {
            width: 100%;
        }
        .auto-hint {
            font-size: 0.8rem;
            color: #2a9d8f;
            margin: 8px 0 4px 8px;
        }
        .btn-manual-query {
            background: #2a9d8f;
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
        }
        .result-box {
            background: white;
            border-radius: 24px;
            padding: 18px;
            margin-top: 24px;
            border: 1px solid #cee5e0;
        }
        .result-title {
            font-weight: 700;
            color: #0b4452;
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }
        .transit-card {
            background: #f9fefe;
            border-left: 8px solid #2a9d8f;
            padding: 18px 16px;
            border-radius: 20px;
            margin-bottom: 14px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .transit-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0f3b4c;
            flex: 1 1 100%;
        }
        .badge {
            background: #def0ec;
            padding: 8px 16px;
            border-radius: 40px;
            color: #146359;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }
        .empty-msg {
            color: #617e8a;
            padding: 22px;
            text-align: center;
            background: #f6fafc;
            border-radius: 20px;
            font-size: 1rem;
        }
        .table-responsive {
            overflow-x: auto;
            margin-top: 18px;
            border-radius: 20px;
            background: white;
            padding: 4px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 420px;
            font-size: 0.9rem;
        }
        th {
            background: #ddeef2;
            color: #104451;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 16px 12px;
            text-align: left;
            letter-spacing: 0.04em;
        }
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e1ebef;
            background: white;
            vertical-align: middle;
        }
        .delete-btn {
            background: none;
            border: 1.5px solid #ffaa99;
            color: #b23e2c;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            background: #fff6f3;
            white-space: nowrap;
        }
        .delete-btn:hover {
            background: #ffe9e4;
        }
        .stats {
            font-size: 0.9rem;
            color: #2f6a78;
            font-weight: 600;
            background: #e2f0f2;
            padding: 6px 18px;
            border-radius: 30px;
            display: inline-block;
        }
        .flex-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }
        .footer-note {
            margin-top: 20px;
            color: #4d707d;
            font-size: 0.8rem;
            text-align: center;
            border-top: 1px solid #d0e0e5;
            padding-top: 20px;
        }
        button, .btn, select, input[type="file"] {
            touch-action: manipulation;
        }
        .encoding-tip {
            background: #fff1e0;
            border-left: 6px solid #e67e22;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #5a3e1b;
            margin-top: 16px;
        }
        .auto-query-tip {
            background: #e0f2fe;
            border-left: 6px solid #0284c7;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 0.8rem;
            color: #075985;
            margin-bottom: 12px;
        }
        /* å¯†ç è¡Œæ ·å¼ */
        .password-row {
            margin: 16px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f0f6f9;
            padding: 12px 16px;
            border-radius: 60px;
        }
        .password-row label {
            font-weight: 600;
            color: #0f4b5c;
        }
        .password-row input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #bcd4db;
            border-radius: 40px;
            font-size: 0.95rem;
            background: white;
        }
        .password-row button {
            background: #2a9d8f;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        .test-connection {
            margin: 10px 0 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .test-connection button {
            background: #0284c7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 40px;
            cursor: pointer;
        }
        .test-connection span {
            color: #0f4b5c;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>ğŸ“¦ é€šåŒ–é‚®æ”¿è½¬è¿æŸ¥è¯¢ <span>ğŸ“¦</span></h1>

        <div class="flex-row">
            <!-- å¿«é€’å‘˜æŸ¥è¯¢å•å…ƒ -->
            <div class="card">
                <h2>ğŸ” å¿«é€’å‘˜æŸ¥è¯¢</h2>
                <div class="query-area">
                    <div class="auto-query-tip">âš¡ å¿«é€Ÿé€‰æ‹©ï¼šä¸‹æ‹‰é€‰ç‚¹åè‡ªåŠ¨åŒ¹é…</div>
                    <div class="select-row">
                        <select id="originSelect"><option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option></select>
                        <select id="destSelect"><option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option></select>
                        <button id="queryBtn" class="btn btn-primary">ğŸ” ä¸‹æ‹‰æŸ¥è¯¢</button>
                    </div>
                    <div class="manual-row">
                        <div class="manual-title">æ‰‹åŠ¨è¾“å…¥ç›®çš„åœ°ï¼ˆè‡ªåŠ¨æŸ¥è¯¢ï¼‰</div>
                        <div class="input-row">
                            <input type="text" id="manualOrigin" placeholder="è¾“å…¥å‘ä»¶åœ°ï¼ˆå¦‚ï¼šæ·±åœ³ï¼‰">
                            <input type="text" id="manualDest" placeholder="è¾“å…¥æ”¶ä»¶åœ°ï¼ˆå¦‚ï¼šå—äº¬ï¼‰">
                        </div>
                        <div class="auto-hint">â±ï¸ è¾“å…¥å®Œæˆåç¨ç­‰ç‰‡åˆ»ï¼Œè‡ªåŠ¨æ˜¾ç¤ºç»“æœ</div>
                        <button id="manualQueryBtn" class="btn btn-manual-query">âœï¸ æ‰‹åŠ¨æŸ¥è¯¢ï¼ˆå¤‡ç”¨ï¼‰</button>
                    </div>
                    <div class="result-box">
                        <div class="result-title">
                            <span>ğŸšš åŒ¹é…è½¬è¿ç«™</span>
                            <span id="resultCount" style="background: #2a9d8f20; padding:5px 16px; border-radius:40px;">0</span>
                        </div>
                        <div id="resultList"><div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div></div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†è½¬è¿ç«™å•å…ƒï¼ˆé»˜è®¤æŠ˜å ï¼Œç‚¹å‡»å±•å¼€éœ€å¯†ç éªŒè¯ï¼‰ -->
            <div class="card">
                <details id="manageDetails" class="manage-details">
                    <summary>âš™ï¸ ç®¡ç†è½¬è¿ç«™</summary>
                    <div class="manage-content">
                        <!-- æµ‹è¯•è¿æ¥ -->
                        <div class="test-connection">
                            <button id="testConnectionBtn">ğŸ”„ æµ‹è¯•è¿æ¥</button>
                            <span id="connectionStatus"></span>
                        </div>

                        <!-- ç®¡ç†å‘˜å¯†ç è¾“å…¥æ¡†ï¼ˆå§‹ç»ˆå¯æ‰‹åŠ¨å½•å…¥ï¼‰ -->
                        <div class="password-row">
                            <label>ğŸ”‘ ç®¡ç†å¯†ç </label>
                            <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆéªŒè¯æˆåŠŸåè‡ªåŠ¨å¡«å……ï¼‰">
                            <button id="clearPasswordBtn" type="button">æ¸…é™¤</button>
                        </div>
                        <p style="font-size:0.8rem; color:#0f4b5c; margin:0 0 12px 8px;">æç¤ºï¼šå¯†ç å¯æ‰‹åŠ¨ä¿®æ”¹ï¼Œæ‰€æœ‰ä¿®æ”¹æ“ä½œå°†ä½¿ç”¨å½“å‰æ¡†å†…å¯†ç ã€‚è‹¥å¯†ç é”™è¯¯ä¼šè‡ªåŠ¨å¼¹å‡ºè¾“å…¥çª—å£ã€‚</p>

                        <div class="btn-group">
                            <label for="importFile" class="btn btn-outline">ğŸ“‚ å¯¼å…¥æ›¿æ¢</label>
                            <input type="file" id="importFile" class="file-input" accept=".csv, text/csv, text/plain">
                            <button id="exportBtn" class="btn btn-outline">â¬‡ï¸ å¯¼å‡ºCSV</button>
                            <label for="updateFile" class="btn btn-primary">ğŸ”„ ä¸Šä¼ æ›´æ–°</label>
                            <input type="file" id="updateFile" class="file-input" accept=".csv, text/csv, text/plain">
                        </div>

                        <div class="encoding-tip">
                            ğŸ’¡ æ‰€æœ‰ä¿®æ”¹æ“ä½œéœ€è¾“å…¥ä¸Šæ–¹å¯†ç ï¼ˆå¯æ‰‹åŠ¨è¾“å…¥ï¼‰ã€‚<br>
                            æ•°æ®äº‘ç«¯å­˜å‚¨ï¼Œå¤šç”¨æˆ·å…±äº«ã€‚
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label>ğŸš© è½¬è¿ç«™åç§°</label>
                                <input type="text" id="newStationName" placeholder="ä¾‹ï¼šä¸Šæµ·æµ¦ä¸œè¥¿">
                            </div>
                            <div class="input-group">
                                <label>ğŸ“¤ å‘ä»¶ç›®çš„åœ°</label>
                                <input type="text" id="newOrigin" placeholder="åŸå¸‚/åŒºåŸŸ">
                            </div>
                            <div class="input-group">
                                <label>ğŸ“¥ æ”¶ä»¶ç›®çš„åœ°</label>
                                <input type="text" id="newDest" placeholder="åŸå¸‚/åŒºåŸŸ">
                            </div>
                            <button id="addRecordBtn" class="btn btn-primary" style="width:100%;">â• æ·»åŠ æ­¤è·¯çº¿</button>
                        </div>

                        <div class="section-header">
                            <span style="font-weight:700;">ğŸ“‹ å½“å‰è½¬è¿è¡¨</span>
                            <span id="recordCount" class="stats">0 æ¡</span>
                        </div>
                        <div class="table-responsive">
                            <table id="stationTable">
                                <thead><tr><th>è½¬è¿ç«™</th><th>å‘ä»¶åœ°</th><th>æ”¶ä»¶åœ°</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div class="footer-note">
            ğŸ“± æŠ˜å å¯†ç å¢å¼ºç‰ˆ Â· æ¯æ¬¡å±•å¼€éœ€å¯†ç  Â· æ·»åŠ æ“ä½œè‡ªåŠ¨å¤„ç†å¯†ç é”™è¯¯
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== é…ç½® ==========
            // âš ï¸ è¯·æ›¿æ¢ä¸ºæ‚¨çš„ Worker åŸŸå + /api
            const API_BASE = 'https://express-transfer-api.511561460.workers.dev/api';  // <-- ä¿®æ”¹è¿™é‡Œï¼

            const DEFAULT_STATIONS = [
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "åŒ—äº¬" },
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "å¹¿å·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "ä¸Šæµ·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "å—äº¬" },
                { station: "æˆéƒ½é’ç™½æ±Ÿä¸­è½¬ç«™", origin: "æˆéƒ½", destination: "åŒ—äº¬" },
                { station: "è¥¿å®‰é™†æ¸¯è½¬è¿åœº", origin: "è¥¿å®‰", destination: "å…°å·" }
            ];

            let stations = [];

            // DOM å…ƒç´ 
            const tableBody = document.getElementById('tableBody');
            const originSelect = document.getElementById('originSelect');
            const destSelect = document.getElementById('destSelect');
            const queryBtn = document.getElementById('queryBtn');
            const manualOrigin = document.getElementById('manualOrigin');
            const manualDest = document.getElementById('manualDest');
            const manualQueryBtn = document.getElementById('manualQueryBtn');
            const resultList = document.getElementById('resultList');
            const resultCount = document.getElementById('resultCount');
            const recordCountSpan = document.getElementById('recordCount');
            const newStationName = document.getElementById('newStationName');
            const newOrigin = document.getElementById('newOrigin');
            const newDest = document.getElementById('newDest');
            const addRecordBtn = document.getElementById('addRecordBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            const updateFile = document.getElementById('updateFile');
            const adminPassword = document.getElementById('adminPassword');
            const testConnectionBtn = document.getElementById('testConnectionBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const clearPasswordBtn = document.getElementById('clearPasswordBtn');
            const manageDetails = document.getElementById('manageDetails');

            // ========== API äº¤äº’ ==========
            async function loadFromAPI() {
                try {
                    const response = await fetch(`${API_BASE}/stations`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('ä» API åŠ è½½å¤±è´¥', error);
                    const backup = localStorage.getItem('transit_stations_backup');
                    if (backup) {
                        try {
                            const parsed = JSON.parse(backup);
                            if (Array.isArray(parsed)) return parsed;
                        } catch (e) {}
                    }
                    return null;
                }
            }

            async function verifyPassword(pwd) {
                try {
                    const response = await fetch(`${API_BASE}/verify-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: pwd })
                    });
                    const result = await response.json();
                    return response.ok ? result.success : false;
                } catch (error) {
                    console.error('éªŒè¯å¯†ç å¤±è´¥', error);
                    return false;
                }
            }

            /**
             * å¢å¼ºç‰ˆä¿å­˜å‡½æ•°ï¼šè‡ªåŠ¨å¤„ç†å¯†ç ä¸ºç©ºæˆ–å¯†ç é”™è¯¯çš„æƒ…å†µ
             * @param {Array} data è¦ä¿å­˜çš„æ•°æ®
             * @param {number} retryCount å†…éƒ¨é‡è¯•è®¡æ•°ï¼Œè°ƒç”¨æ—¶ä¸è¦ä¼ 
             * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸ
             */
            async function saveToAPI(data, retryCount = 0) {
                // æœ€å¤šé‡è¯•3æ¬¡
                if (retryCount >= 3) {
                    alert('å¤šæ¬¡å°è¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    return false;
                }

                let password = adminPassword.value.trim();
                
                // å¦‚æœå¯†ç æ¡†ä¸ºç©ºï¼Œå¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥
                if (!password) {
                    const pwd = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥æ‰§è¡Œæ­¤æ“ä½œï¼š');
                    if (!pwd) return false; // ç”¨æˆ·å–æ¶ˆ
                    // å°†å¯†ç å¡«å…¥æ¡†å†…ï¼Œä¾¿äºåç»­æ“ä½œ
                    adminPassword.value = pwd;
                    password = pwd;
                }

                try {
                    const response = await fetch(`${API_BASE}/stations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password, data })
                    });

                    if (response.ok) {
                        // ä¿å­˜æˆåŠŸåå¤‡ä»½åˆ°æœ¬åœ°
                        localStorage.setItem('transit_stations_backup', JSON.stringify(data));
                        return true;
                    }

                    // å¤„ç†é”™è¯¯å“åº”
                    const err = await response.json();
                    if (response.status === 403) {
                        // å¯†ç é”™è¯¯
                        alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
                        // æ¸…ç©ºå¯†ç æ¡†ï¼Œè®©ç”¨æˆ·é‡æ–°è¾“å…¥
                        adminPassword.value = '';
                        // é€’å½’é‡è¯•
                        return saveToAPI(data, retryCount + 1);
                    } else {
                        alert(`ä¿å­˜å¤±è´¥: ${err.error || 'æœªçŸ¥é”™è¯¯'}`);
                        return false;
                    }
                } catch (error) {
                    console.error('ä¿å­˜åˆ° API å¤±è´¥', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    return false;
                }
            }

            async function loadStations() {
                const data = await loadFromAPI();
                if (data && Array.isArray(data)) {
                    stations = data;
                } else {
                    stations = [...DEFAULT_STATIONS];
                    await saveToAPI(stations);
                }
                return stations;
            }

            async function saveStationsAndRefresh() {
                const success = await saveToAPI(stations);
                if (success) {
                    refreshUI();
                }
            }

            // ========== UI æ¸²æŸ“ ==========
            function renderTable() {
                if (!tableBody) return;
                if (stations.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px;">ğŸ“­ æš‚æ— æ•°æ®</td></tr>`;
                    return;
                }
                let html = '';
                stations.forEach((item, index) => {
                    html += `<tr>
                        <td style="font-weight:600;">${escapeHtml(item.station)}</td>
                        <td>${escapeHtml(item.origin)}</td>
                        <td>${escapeHtml(item.destination)}</td>
                        <td><button class="delete-btn" data-index="${index}">åˆ é™¤</button></td>
                    </tr>`;
                });
                tableBody.innerHTML = html;
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                        if (!isNaN(index) && index >= 0 && index < stations.length) {
                            stations.splice(index, 1);
                            await saveStationsAndRefresh();
                        }
                    });
                });
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function updateRecordCount() {
                if (recordCountSpan) recordCountSpan.innerText = `${stations.length} æ¡`;
            }

            function renderDropdowns() {
                if (!originSelect || !destSelect) return;
                const origins = [...new Set(stations.map(s => s.origin).filter(Boolean))].sort();
                const destinations = [...new Set(stations.map(s => s.destination).filter(Boolean))].sort();

                const oldOrigin = originSelect.value;
                const oldDest = destSelect.value;

                originSelect.innerHTML = `<option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option>` +
                    origins.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
                destSelect.innerHTML = `<option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option>` +
                    destinations.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

                if (origins.includes(oldOrigin)) originSelect.value = oldOrigin;
                if (destinations.includes(oldDest)) destSelect.value = oldDest;
            }

            function clearQueryResult() {
                resultList.innerHTML = `<div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div>`;
                resultCount.innerText = '0';
            }

            function queryTransitStation(origin, dest) {
                if (!origin || !dest) {
                    clearQueryResult();
                    return;
                }
                const matched = stations.filter(item => item.origin === origin && item.destination === dest);
                if (matched.length === 0) {
                    resultList.innerHTML = `<div class="empty-msg">ğŸš« æ— åŒ¹é…è½¬è¿ç«™<br><span style="font-size:0.85rem;">${escapeHtml(origin)} â†’ ${escapeHtml(dest)}</span></div>`;
                    resultCount.innerText = '0';
                } else {
                    let html = '';
                    matched.forEach(item => {
                        html += `<div class="transit-card">
                            <span class="transit-name">ğŸš› ${escapeHtml(item.station)}</span>
                            <span class="badge">${escapeHtml(item.origin)}</span>
                            <span style="color: #2a9d8f;">â†’</span>
                            <span class="badge">${escapeHtml(item.destination)}</span>
                        </div>`;
                    });
                    resultList.innerHTML = html;
                    resultCount.innerText = `${matched.length}`;
                }
            }

            function refreshUI() {
                renderTable();
                renderDropdowns();
                updateRecordCount();
                clearQueryResult();
            }

            // ========== æŠ˜å é¢æ¿å¯†ç éªŒè¯ ==========
            const summary = manageDetails.querySelector('summary');
            summary.addEventListener('click', async (e) => {
                // é˜»æ­¢é»˜è®¤çš„ toggle è¡Œä¸ºï¼Œç”±æˆ‘ä»¬æ§åˆ¶å±•å¼€
                e.preventDefault();

                // å¦‚æœå·²ç»å±•å¼€ï¼Œåˆ™è®©æµè§ˆå™¨æ‰§è¡Œé»˜è®¤æŠ˜å ï¼ˆä¸é˜»æ­¢é»˜è®¤ï¼‰
                if (manageDetails.open) {
                    // è¿™é‡Œæˆ‘ä»¬ä¸è®¾ç½® open ä¸º falseï¼Œè€Œæ˜¯è®©æµè§ˆå™¨å¤„ç†é»˜è®¤è¡Œä¸ºï¼ˆå› ä¸ºæˆ‘ä»¬é˜»æ­¢äº†é»˜è®¤ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼‰
                    // ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®©æµè§ˆå™¨å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œåˆ¤æ–­å¦‚æœå·²å±•å¼€ï¼Œå°±æ”¾è¡Œ
                    // ä½†æ˜¯ e.preventDefault å·²ç»é˜»æ­¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è®¾ç½® open = false æ¥æŠ˜å 
                    manageDetails.open = false;
                    return;
                }

                // å¦‚æœæœªå±•å¼€ï¼Œæ‰§è¡Œå¯†ç éªŒè¯
                const pwd = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥å±•å¼€ç®¡ç†é¢æ¿ï¼š');
                if (!pwd) return;

                const isValid = await verifyPassword(pwd);
                if (isValid) {
                    manageDetails.open = true;
                    adminPassword.value = pwd;
                } else {
                    alert('å¯†ç é”™è¯¯ï¼Œæ— æ³•å±•å¼€ç®¡ç†é¢æ¿');
                }
            });

            // ========== å…¶ä»–äº‹ä»¶ç»‘å®š ==========
            function bindEvents() {
                // æµ‹è¯•è¿æ¥
                testConnectionBtn.addEventListener('click', async () => {
                    connectionStatus.innerText = 'è¿æ¥ä¸­...';
                    try {
                        const response = await fetch(`${API_BASE}/stations`);
                        if (response.ok) {
                            connectionStatus.innerText = 'âœ… è¿æ¥æˆåŠŸ';
                        } else {
                            connectionStatus.innerText = `âŒ å¤±è´¥ (HTTP ${response.status})`;
                        }
                    } catch (error) {
                        connectionStatus.innerText = 'âŒ ç½‘ç»œé”™è¯¯';
                    }
                });

                // æ¸…é™¤å¯†ç æŒ‰é’®ï¼šæ¸…ç©ºå¯†ç æ¡†
                clearPasswordBtn.addEventListener('click', () => {
                    adminPassword.value = '';
                    adminPassword.focus();
                });

                // æŸ¥è¯¢
                queryBtn.addEventListener('click', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });
                originSelect.addEventListener('change', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });
                destSelect.addEventListener('change', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });

                manualQueryBtn.addEventListener('click', () => {
                    const origin = manualOrigin.value.trim();
                    const dest = manualDest.value.trim();
                    if (origin && dest) queryTransitStation(origin, dest);
                    else alert('è¯·å®Œæ•´å¡«å†™å‘ä»¶åœ°å’Œæ”¶ä»¶åœ°');
                });

                // æ‰‹åŠ¨è¾“å…¥è‡ªåŠ¨æŸ¥è¯¢ï¼ˆé˜²æŠ–ï¼‰
                let manualTimer;
                manualOrigin.addEventListener('input', () => {
                    clearTimeout(manualTimer);
                    manualTimer = setTimeout(() => {
                        const origin = manualOrigin.value.trim();
                        const dest = manualDest.value.trim();
                        if (origin && dest) queryTransitStation(origin, dest);
                    }, 500);
                });
                manualDest.addEventListener('input', () => {
                    clearTimeout(manualTimer);
                    manualTimer = setTimeout(() => {
                        const origin = manualOrigin.value.trim();
                        const dest = manualDest.value.trim();
                        if (origin && dest) queryTransitStation(origin, dest);
                    }, 500);
                });

                // æ·»åŠ è®°å½•
                addRecordBtn.addEventListener('click', async function() {
                    const station = newStationName.value.trim();
                    const origin = newOrigin.value.trim();
                    const dest = newDest.value.trim();
                    if (!station || !origin || !dest) {
                        alert('è½¬è¿ç«™ã€å‘ä»¶åœ°ã€æ”¶ä»¶åœ°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    stations.push({ station, origin, destination: dest });
                    await saveStationsAndRefresh();
                    newStationName.value = '';
                    newOrigin.value = '';
                    newDest.value = '';
                });

                // å¯¼å‡º CSV
                exportBtn.addEventListener('click', function() {
                    if (stations.length === 0) {
                        alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    let csvContent = "è½¬è¿ç«™,å‘ä»¶ç›®çš„åœ°,æ”¶ä»¶ç›®çš„åœ°\n";
                    stations.forEach(item => {
                        csvContent += `${item.station},${item.origin},${item.destination}\n`;
                    });
                    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è½¬è¿ç«™æ•°æ®_${Date.now()}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                });

                // å¯¼å…¥ CSVï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨ GB2312 ç¼–ç ï¼‰
                importFile.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const content = ev.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) {
                            alert('CSVç¼ºå°‘æ•°æ®è¡Œ');
                            return;
                        }
                        const newStations = [];
                        for (let i = 1; i < lines.length; i++) {
                            const parts = lines[i].split(',').map(s => s.trim());
                            if (parts.length >= 3) {
                                newStations.push({ station: parts[0], origin: parts[1], destination: parts[2] });
                            }
                        }
                        if (newStations.length === 0) {
                            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®');
                            return;
                        }
                        stations = newStations;
                        await saveStationsAndRefresh();
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${newStations.length} æ¡è®°å½•`);
                        importFile.value = '';
                    };
                    reader.readAsText(file, 'GB2312');
                });

                // ä¸Šä¼ æ›´æ–°ï¼ˆåŒå¯¼å…¥ï¼‰
                updateFile.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const content = ev.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) {
                            alert('CSVç¼ºå°‘æ•°æ®è¡Œ');
                            return;
                        }
                        const newStations = [];
                        for (let i = 1; i < lines.length; i++) {
                            const parts = lines[i].split(',').map(s => s.trim());
                            if (parts.length >= 3) {
                                newStations.push({ station: parts[0], origin: parts[1], destination: parts[2] });
                            }
                        }
                        if (newStations.length === 0) {
                            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®');
                            return;
                        }
                        stations = newStations;
                        await saveStationsAndRefresh();
                        alert(`âœ… æˆåŠŸæ›´æ–° ${newStations.length} æ¡è®°å½•`);
                        updateFile.value = '';
                    };
                    reader.readAsText(file, 'GB2312');
                });
            }

            // åˆå§‹åŒ–
            async function init() {
                document.body.classList.add('loading');
                await loadStations();
                refreshUI();
                bindEvents();
                document.body.classList.remove('loading');

                // ç¡®ä¿åˆå§‹é¢æ¿æŠ˜å 
                manageDetails.open = false;

                setTimeout(() => {
                    if (originSelect.value && destSelect.value) {
                        queryTransitStation(originSelect.value, destSelect.value);
                    }
                }, 100);
            }

            init();
        })();
    </script>
</body>
</html>

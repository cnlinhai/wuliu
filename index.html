<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>å¿«é€’è½¬è¿ Â· æ‰‹åŠ¨è‡ªåŠ¨</title>
    <style>
        /* ----- ç§»åŠ¨ç«¯æ ·å¼ï¼ˆåŸºäºåŸç‰ˆï¼Œå¢åŠ æ‰‹åŠ¨è¾“å…¥åŒºåŸŸæ ·å¼ï¼‰----- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f2f7fb;
            color: #1e2e3e;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: #0a3b4e;
            border-left: 6px solid #2a9d8f;
            padding-left: 16px;
        }
        h1 span {
            background: #2a9d8f;
            color: white;
            font-size: 0.7rem;
            padding: 3px 10px;
            border-radius: 30px;
            font-weight: 600;
        }
        h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f4b5c;
        }
        .card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            padding: 22px 20px;
            margin-bottom: 20px;
            border: 1px solid #eaf0f3;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: white;
            border: 1px solid #cbd8e0;
            padding: 14px 22px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1rem;
            color: #134e5e;
            background: #f9fdff;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            line-height: 1;
            white-space: nowrap;
        }
        .btn-primary {
            background: #0f3b5e;
            color: white;
            border: none;
            background: linear-gradient(145deg, #1a5a6e, #0e485a);
            box-shadow: 0 6px 12px rgba(13,79,88,0.2);
        }
        .btn-outline {
            border: 1.5px solid #2a9d8f;
            color: #2a9d8f;
            background: white;
        }
        .btn-sm {
            padding: 10px 18px;
            font-size: 0.9rem;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            margin-bottom: 24px;
        }
        .btn-group .btn {
            flex: 1 0 calc(50% - 14px);
            white-space: normal;
            word-break: break-word;
        }
        .file-input {
            display: none;
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f6fbfd;
            padding: 22px 18px;
            border-radius: 24px;
            margin-bottom: 8px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .input-group label {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #436c7a;
            margin-left: 6px;
        }
        input, select {
            width: 100%;
            padding: 16px 18px;
            border: 1.5px solid #d4e2ea;
            border-radius: 30px;
            font-size: 1rem;
            background: white;
            transition: 0.2s;
            outline: none;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        input:focus, select:focus {
            border-color: #2a9d8f;
            box-shadow: 0 0 0 4px rgba(42,157,143,0.12);
        }
        .query-area {
            background: #eaf5f3;
            border-radius: 28px;
            padding: 22px 18px;
        }
        .select-row {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }
        .select-row select {
            width: 100%;
        }
        .select-row .btn {
            width: 100%;
            margin-top: 6px;
            padding: 16px;
        }
        /* æ‰‹åŠ¨è¾“å…¥åŒºåŸŸæ ·å¼ */
        .manual-row {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed #bcd4db;
        }
        .manual-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1d6f64;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .manual-title::before {
            content: "âœï¸";
            font-size: 1.2rem;
        }
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .input-row input {
            width: 100%;
        }
        .auto-hint {
            font-size: 0.8rem;
            color: #2a9d8f;
            margin: 8px 0 4px 8px;
        }
        .btn-manual-query {
            background: #2a9d8f;
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
        }
        .result-box {
            background: white;
            border-radius: 24px;
            padding: 18px;
            margin-top: 24px;
            border: 1px solid #cee5e0;
        }
        .result-title {
            font-weight: 700;
            color: #0b4452;
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }
        .transit-card {
            background: #f9fefe;
            border-left: 8px solid #2a9d8f;
            padding: 18px 16px;
            border-radius: 20px;
            margin-bottom: 14px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .transit-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0f3b4c;
            flex: 1 1 100%;
        }
        .badge {
            background: #def0ec;
            padding: 8px 16px;
            border-radius: 40px;
            color: #146359;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
        }
        .empty-msg {
            color: #617e8a;
            padding: 22px;
            text-align: center;
            background: #f6fafc;
            border-radius: 20px;
            font-size: 1rem;
        }
        .table-responsive {
            overflow-x: auto;
            margin-top: 18px;
            border-radius: 20px;
            background: white;
            padding: 4px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 420px;
            font-size: 0.9rem;
        }
        th {
            background: #ddeef2;
            color: #104451;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 16px 12px;
            text-align: left;
            letter-spacing: 0.04em;
        }
        td {
            padding: 16px 12px;
            border-bottom: 1px solid #e1ebef;
            background: white;
            vertical-align: middle;
        }
        .delete-btn {
            background: none;
            border: 1.5px solid #ffaa99;
            color: #b23e2c;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
            background: #fff6f3;
            white-space: nowrap;
        }
        .delete-btn:hover {
            background: #ffe9e4;
        }
        .stats {
            font-size: 0.9rem;
            color: #2f6a78;
            font-weight: 600;
            background: #e2f0f2;
            padding: 6px 18px;
            border-radius: 30px;
            display: inline-block;
        }
        .flex-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }
        .footer-note {
            margin-top: 20px;
            color: #4d707d;
            font-size: 0.8rem;
            text-align: center;
            border-top: 1px solid #d0e0e5;
            padding-top: 20px;
        }
        button, .btn, select, input[type="file"] {
            touch-action: manipulation;
        }
        .encoding-tip {
            background: #fff1e0;
            border-left: 6px solid #e67e22;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #5a3e1b;
            margin-top: 16px;
        }
        .auto-query-tip {
            background: #e0f2fe;
            border-left: 6px solid #0284c7;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 0.8rem;
            color: #075985;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>
            ğŸ“¦ é€Ÿè½¬è¿ 
            <span>æ‰‹åŠ¨è‡ªåŠ¨</span>
        </h1>

        <div class="flex-row">
            <!-- 1ï¸âƒ£ å¿«é€’å‘˜æŸ¥è¯¢å•å…ƒï¼ˆä¼˜å…ˆï¼‰- æ‰‹åŠ¨è¾“å…¥è‡ªåŠ¨æŸ¥è¯¢ -->
            <div class="card">
                <h2>ğŸ” å¿«é€’å‘˜æŸ¥è¯¢</h2>
                <div class="query-area">
                    <div class="auto-query-tip">
                        âš¡ å¿«é€Ÿé€‰æ‹©ï¼šä¸‹æ‹‰é€‰ç‚¹åè‡ªåŠ¨åŒ¹é…
                    </div>
                    <div class="select-row">
                        <select id="originSelect">
                            <option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option>
                        </select>
                        <select id="destSelect">
                            <option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option>
                        </select>
                        <button id="queryBtn" class="btn btn-primary">ğŸ” ä¸‹æ‹‰æŸ¥è¯¢</button>
                    </div>

                    <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸï¼ˆå¸¦è‡ªåŠ¨åæ˜¾ï¼‰ -->
                    <div class="manual-row">
                        <div class="manual-title">æ‰‹åŠ¨è¾“å…¥ç›®çš„åœ°ï¼ˆè‡ªåŠ¨æŸ¥è¯¢ï¼‰</div>
                        <div class="input-row">
                            <input type="text" id="manualOrigin" placeholder="è¾“å…¥å‘ä»¶åœ°ï¼ˆå¦‚ï¼šæ·±åœ³ï¼‰" value="">
                            <input type="text" id="manualDest" placeholder="è¾“å…¥æ”¶ä»¶åœ°ï¼ˆå¦‚ï¼šå—äº¬ï¼‰" value="">
                        </div>
                        <div class="auto-hint">â±ï¸ è¾“å…¥å®Œæˆåç¨ç­‰ç‰‡åˆ»ï¼Œè‡ªåŠ¨æ˜¾ç¤ºç»“æœ</div>
                        <button id="manualQueryBtn" class="btn btn-manual-query">âœï¸ æ‰‹åŠ¨æŸ¥è¯¢ï¼ˆå¤‡ç”¨ï¼‰</button>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-title">
                            <span>ğŸšš åŒ¹é…è½¬è¿ç«™</span>
                            <span id="resultCount" style="background: #2a9d8f20; padding: 5px 16px; border-radius: 40px; font-size: 0.9rem;">0</span>
                        </div>
                        <div id="resultList">
                            <div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; color: #366f7c; padding: 6px 10px; font-size: 0.9rem; background: #ecf6f4; border-radius: 30px; text-align: center;">
                    âš¡ å®æ—¶åŒ¹é…ï¼Œæ•°æ®æœ¬åœ°ä¿å­˜
                </div>
            </div>

            <!-- 2ï¸âƒ£ ç®¡ç†è½¬è¿ç«™å•å…ƒï¼ˆä¸‹æ–¹ï¼‰ä¿æŒä¸å˜ -->
            <div class="card">
                <h2>âš™ï¸ ç®¡ç†è½¬è¿ç«™</h2>
                
                <div class="btn-group">
                    <label for="importFile" class="btn btn-outline">ğŸ“‚ å¯¼å…¥æ›¿æ¢</label>
                    <input type="file" id="importFile" class="file-input" accept=".csv, text/csv, text/plain">
                    
                    <button id="exportBtn" class="btn btn-outline">â¬‡ï¸ å¯¼å‡ºCSV</button>
                    
                    <label for="updateFile" class="btn btn-primary">ğŸ”„ ä¸Šä¼ æ›´æ–°</label>
                    <input type="file" id="updateFile" class="file-input" accept=".csv, text/csv, text/plain">
                </div>

                <div class="encoding-tip">
                    ğŸ’¡ <strong>å¯¼å…¥é»˜è®¤GB2312/GBK</strong>ï¼ˆExcelä¿å­˜çš„ANSIæ ¼å¼ç›´æ¥ä¸Šä¼ ï¼‰<br>
                    â¬‡ï¸ å¯¼å‡ºä¸ºUTF-8+BOMï¼ŒExcelåŒå‡»ç›´æ¥æ‰“å¼€ï¼ˆä¸ä¹±ç ï¼‰<br>
                    ğŸ”„ ä¸Šä¼ æ›´æ–°è‡ªåŠ¨è¯†åˆ«UTF-8/UTF-16 BOMï¼Œæ— BOMæ—¶æŒ‰GB2312è§£ç ã€‚
                </div>

                <div class="form-row">
                    <div class="input-group">
                        <label>ğŸš© è½¬è¿ç«™åç§°</label>
                        <input type="text" id="newStationName" placeholder="ä¾‹ï¼šä¸Šæµ·æµ¦ä¸œè¥¿" value="">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“¤ å‘ä»¶ç›®çš„åœ°</label>
                        <input type="text" id="newOrigin" placeholder="åŸå¸‚/åŒºåŸŸ" value="">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“¥ æ”¶ä»¶ç›®çš„åœ°</label>
                        <input type="text" id="newDest" placeholder="åŸå¸‚/åŒºåŸŸ" value="">
                    </div>
                    <button id="addRecordBtn" class="btn btn-primary" style="width:100%; margin-top: 8px;">â• æ·»åŠ æ­¤è·¯çº¿</button>
                </div>

                <div class="section-header">
                    <span style="font-weight: 700; color: #0f4b5c;">ğŸ“‹ å½“å‰è½¬è¿è¡¨</span>
                    <span id="recordCount" class="stats">0 æ¡</span>
                </div>
                <div class="table-responsive">
                    <table id="stationTable">
                        <thead>
                            <tr>
                                <th>è½¬è¿ç«™</th>
                                <th>å‘ä»¶åœ°</th>
                                <th>æ”¶ä»¶åœ°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- JSæ¸²æŸ“ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer-note">
            ğŸ“± ç§»åŠ¨ä¸“ä¸šç‰ˆ Â· ä¸‹æ‹‰è‡ªåŠ¨+æ‰‹åŠ¨è‡ªåŠ¨ Â· å¯¼å…¥é»˜è®¤GB2312 Â· å¯¼å‡ºUTF-8+BOM
        </div>
    </div>

    <script>
        (function(){
            "use strict";

            const STORAGE_KEY = 'transit_stations_manual_auto';
            const DEFAULT_STATIONS = [
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "åŒ—äº¬" },
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "å¹¿å·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "ä¸Šæµ·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "å—äº¬" },
                { station: "æˆéƒ½é’ç™½æ±Ÿä¸­è½¬ç«™", origin: "æˆéƒ½", destination: "åŒ—äº¬" },
                { station: "è¥¿å®‰é™†æ¸¯è½¬è¿åœº", origin: "è¥¿å®‰", destination: "å…°å·" }
            ];

            let stations = [];

            // DOM å…ƒç´ 
            const tableBody = document.getElementById('tableBody');
            const originSelect = document.getElementById('originSelect');
            const destSelect = document.getElementById('destSelect');
            const queryBtn = document.getElementById('queryBtn');
            const manualOrigin = document.getElementById('manualOrigin');
            const manualDest = document.getElementById('manualDest');
            const manualQueryBtn = document.getElementById('manualQueryBtn');
            const resultList = document.getElementById('resultList');
            const resultCount = document.getElementById('resultCount');
            const recordCountSpan = document.getElementById('recordCount');
            const newStationName = document.getElementById('newStationName');
            const newOrigin = document.getElementById('newOrigin');
            const newDest = document.getElementById('newDest');
            const addRecordBtn = document.getElementById('addRecordBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            const updateFile = document.getElementById('updateFile');

            // ---------- å­˜å‚¨è¾…åŠ© ----------
            function saveToStorage() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stations));
            }

            function loadFromStorage() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        stations = JSON.parse(stored);
                        if (!Array.isArray(stations)) stations = [...DEFAULT_STATIONS];
                    } catch (e) {
                        stations = [...DEFAULT_STATIONS];
                    }
                } else {
                    stations = [...DEFAULT_STATIONS];
                    saveToStorage();
                }
                stations = stations.filter(item => item && typeof item === 'object' && item.station && item.origin && item.destination);
                return stations;
            }

            // ---------- æ¸²æŸ“UI ----------
            function refreshUI() {
                renderTable();
                renderDropdowns();
                updateRecordCount();
                // æ¸…ç©ºæŸ¥è¯¢ç»“æœï¼ˆå› ä¸ºæ•°æ®å˜äº†ï¼Œä¹‹å‰çš„é€‰æ‹©å¯èƒ½å·²ä¸å­˜åœ¨ï¼‰
                clearQueryResult();
            }

            function renderTable() {
                if (!tableBody) return;
                if (stations.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 30px; color: #6a8693;">ğŸ“­ æš‚æ— æ•°æ®ï¼Œè¯·å¯¼å…¥æˆ–æ·»åŠ </td></tr>`;
                    return;
                }
                let html = '';
                stations.forEach((item, index) => {
                    html += `<tr>
                        <td style="font-weight: 600;">${escapeHtml(item.station || '')}</td>
                        <td>${escapeHtml(item.origin || '')}</td>
                        <td>${escapeHtml(item.destination || '')}</td>
                        <td><button class="delete-btn" data-index="${index}">åˆ é™¤</button></td>
                    </tr>`;
                });
                tableBody.innerHTML = html;
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                        if (!isNaN(index) && index >= 0 && index < stations.length) {
                            stations.splice(index, 1);
                            saveToStorage();
                            refreshUI();
                        }
                    });
                });
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function updateRecordCount() {
                if (recordCountSpan) {
                    recordCountSpan.innerText = `${stations.length} æ¡`;
                }
            }

            function renderDropdowns() {
                if (!originSelect || !destSelect) return;
                const origins = [...new Set(stations.map(s => s.origin).filter(Boolean))].sort();
                const destinations = [...new Set(stations.map(s => s.destination).filter(Boolean))].sort();
                
                // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œä»¥ä¾¿åˆ·æ–°åä¿ç•™é€‰æ‹©
                const oldOrigin = originSelect.value;
                const oldDest = destSelect.value;

                let originHtml = `<option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option>`;
                origins.forEach(city => {
                    originHtml += `<option value="${escapeHtml(city)}">${escapeHtml(city)}</option>`;
                });
                originSelect.innerHTML = originHtml;

                let destHtml = `<option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option>`;
                destinations.forEach(city => {
                    destHtml += `<option value="${escapeHtml(city)}">${escapeHtml(city)}</option>`;
                });
                destSelect.innerHTML = destHtml;

                // å°è¯•æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
                if (origins.includes(oldOrigin)) {
                    originSelect.value = oldOrigin;
                }
                if (destinations.includes(oldDest)) {
                    destSelect.value = oldDest;
                }
            }

            function clearQueryResult() {
                if (resultList) {
                    resultList.innerHTML = `<div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div>`;
                }
                if (resultCount) resultCount.innerText = '0';
            }

            // ---------- æ ¸å¿ƒæŸ¥è¯¢ï¼ˆæ”¯æŒä¼ å…¥è‡ªå®šä¹‰origin/destï¼‰----------
            function queryTransitStation(origin, dest) {
                if (!origin || !dest) {
                    clearQueryResult();
                    return;
                }

                const matched = stations.filter(item => item.origin === origin && item.destination === dest);
                if (matched.length === 0) {
                    resultList.innerHTML = `<div class="empty-msg">ğŸš« æ— åŒ¹é…è½¬è¿ç«™<br><span style="font-size:0.85rem;">${escapeHtml(origin)} â†’ ${escapeHtml(dest)}</span></div>`;
                    resultCount.innerText = '0';
                } else {
                    let html = '';
                    matched.forEach(item => {
                        html += `<div class="transit-card">
                            <span class="transit-name">ğŸš› ${escapeHtml(item.station)}</span>
                            <span class="badge">${escapeHtml(item.origin)}</span>
                            <span style="color: #2a9d8f; font-weight: 600;">â†’</span>
                            <span class="badge">${escapeHtml(item.destination)}</span>
                        </div>`;
                    });
                    resultList.innerHTML = html;
                    resultCount.innerText = `${matched.length}`;
                }
            }

            // ---------- è‡ªåŠ¨æŸ¥è¯¢è§¦å‘å™¨ï¼ˆä½¿ç”¨ä¸‹æ‹‰æ¡†çš„å€¼ï¼‰----------
            function autoQueryHandler() {
                const origin = originSelect.value;
                const dest = destSelect.value;
                if (origin && dest) {
                    queryTransitStation(origin, dest);
                } else {
                    clearQueryResult();
                }
            }

            // ---------- æ‰‹åŠ¨æŸ¥è¯¢ï¼ˆä½¿ç”¨è¾“å…¥æ¡†çš„å€¼ï¼‰----------
            function manualQueryHandler() {
                const origin = manualOrigin.value.trim();
                const dest = manualDest.value.trim();
                if (!origin || !dest) {
                    alert('è¯·å®Œæ•´å¡«å†™å‘ä»¶åœ°å’Œæ”¶ä»¶åœ°');
                    return;
                }
                queryTransitStation(origin, dest);
            }

            // ---------- é˜²æŠ–å‡½æ•° ----------
            function debounce(func, delay) {
                let timer;
                return function(...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // æ‰‹åŠ¨è¾“å…¥è‡ªåŠ¨æŸ¥è¯¢ï¼ˆé˜²æŠ–500msï¼‰
            const manualAutoQuery = debounce(function() {
                const origin = manualOrigin.value.trim();
                const dest = manualDest.value.trim();
                if (origin && dest) {
                    queryTransitStation(origin, dest);
                } else {
                    // å¦‚æœä»»ä¸€ä¸ºç©ºï¼Œå¯ä»¥æ¸…ç©ºç»“æœï¼Œä½†ä¸ºäº†ä¸é¢‘ç¹æ¸…ç©ºï¼Œå¯ä»¥é€‰æ‹©ä¸æ“ä½œ
                    // è¿™é‡Œé€‰æ‹©å½“ä¸¤ä¸ªè¾“å…¥æ¡†éƒ½ä¸ä¸ºç©ºæ—¶æ‰æŸ¥è¯¢ï¼Œå¦åˆ™ä¸æ¸…ç©ºï¼ˆé¿å…è¾“å…¥è¿‡ç¨‹ä¸­ç»“æœé—ªçƒï¼‰
                }
            }, 500);

            // ä¸ºæ‰‹åŠ¨è¾“å…¥æ¡†æ·»åŠ  input äº‹ä»¶ç›‘å¬
            manualOrigin.addEventListener('input', manualAutoQuery);
            manualDest.addEventListener('input', manualAutoQuery);

            // ---------- å¯¼å‡ºä¸º UTF-8 + BOMï¼ˆExcelåŒå‡»ç›´æ¥æ‰“å¼€ï¼‰----------
            function exportToCSV() {
                if (stations.length === 0) {
                    alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                let csvContent = "è½¬è¿ç«™,å‘ä»¶ç›®çš„åœ°,æ”¶ä»¶ç›®çš„åœ°\n";
                stations.forEach(item => {
                    csvContent += `${item.station},${item.origin},${item.destination}\n`;
                });

                // åŠ å…¥ UTF-8 BOM
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è½¬è¿ç«™æ•°æ®_${new Date().getTime()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            // ---------- æ™ºèƒ½å¯¼å…¥ï¼šUTF-8/UTF-16 BOMä¼˜å…ˆï¼Œæ— BOMé»˜è®¤GB2312 ----------
            function parseCSVAndReplaceFromArrayBuffer(buffer, source = 'å¯¼å…¥') {
                let content = '';
                const arr = new Uint8Array(buffer);
                
                if (arr.length >= 2 && arr[0] === 0xFF && arr[1] === 0xFE) {
                    const utf16 = new Uint16Array(buffer.slice(2));
                    content = String.fromCharCode.apply(null, utf16);
                }
                else if (arr.length >= 3 && arr[0] === 0xEF && arr[1] === 0xBB && arr[2] === 0xBF) {
                    const decoder = new TextDecoder('utf-8');
                    content = decoder.decode(buffer.slice(3));
                }
                else {
                    try {
                        const decoder = new TextDecoder('gb18030');
                        content = decoder.decode(buffer);
                    } catch(e) {
                        try {
                            const decoder = new TextDecoder('utf-8');
                            content = decoder.decode(buffer);
                        } catch(e2) {
                            alert('è§£ç å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶ä¸ºGB2312æˆ–UTF-8ç¼–ç ');
                            return false;
                        }
                    }
                }

                const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length <= 1) {
                    alert('CSVç¼ºå°‘æ•°æ®è¡Œï¼ˆè‡³å°‘æ ‡é¢˜+1è¡Œæ•°æ®ï¼‰');
                    return false;
                }

                const newStations = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    const parts = line.split(',').map(s => s.trim());
                    if (parts.length >= 3) {
                        const station = parts[0];
                        const origin = parts[1];
                        const dest = parts[2];
                        if (station && origin && dest) {
                            newStations.push({ station, origin, destination: dest });
                        }
                    }
                }

                if (newStations.length === 0) {
                    alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·ç¡®ä¿CSVæ ¼å¼ä¸ºï¼šè½¬è¿ç«™,å‘ä»¶åœ°,æ”¶ä»¶åœ°');
                    return false;
                }

                stations = newStations;
                saveToStorage();
                refreshUI();
                alert(`âœ… æˆåŠŸ${source} ${newStations.length} æ¡è½¬è¿è®°å½•`);
                return true;
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            function bindEvents() {
                // ä¸‹æ‹‰æŸ¥è¯¢æŒ‰é’®ï¼ˆä½¿ç”¨ä¸‹æ‹‰æ¡†çš„å€¼ï¼‰
                queryBtn.addEventListener('click', autoQueryHandler);

                // è‡ªåŠ¨æŸ¥è¯¢ï¼šé€‰æ‹©å‘ä»¶åœ°æˆ–æ”¶ä»¶åœ°æ—¶è‡ªåŠ¨è§¦å‘
                originSelect.addEventListener('change', autoQueryHandler);
                destSelect.addEventListener('change', autoQueryHandler);

                // æ‰‹åŠ¨æŸ¥è¯¢æŒ‰é’®ï¼ˆå¤‡ç”¨ï¼‰
                manualQueryBtn.addEventListener('click', manualQueryHandler);

                // æ·»åŠ è®°å½•
                addRecordBtn.addEventListener('click', function() {
                    const station = newStationName.value.trim();
                    const origin = newOrigin.value.trim();
                    const dest = newDest.value.trim();
                    if (!station || !origin || !dest) {
                        alert('è½¬è¿ç«™ã€å‘ä»¶åœ°ã€æ”¶ä»¶åœ°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    stations.push({ station, origin, destination: dest });
                    saveToStorage();
                    refreshUI();
                    newStationName.value = '';
                    newOrigin.value = '';
                    newDest.value = '';
                });

                // å¯¼å‡º
                exportBtn.addEventListener('click', exportToCSV);

                // å¯¼å…¥ï¼ˆæ›¿æ¢ï¼‰
                importFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        parseCSVAndReplaceFromArrayBuffer(ev.target.result, 'å¯¼å…¥');
                        importFile.value = '';
                    };
                    reader.readAsArrayBuffer(file);
                });

                // ä¸Šä¼ æ›´æ–°ï¼ˆæ›¿æ¢ï¼‰
                updateFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        parseCSVAndReplaceFromArrayBuffer(ev.target.result, 'ä¸Šä¼ æ›´æ–°');
                        updateFile.value = '';
                    };
                    reader.readAsArrayBuffer(file);
                });
            }

            // åˆå§‹åŒ–
            function init() {
                loadFromStorage();
                refreshUI();
                bindEvents();
                // åˆå§‹åŒ–æ—¶å¦‚æœä¸‹æ‹‰æ¡†æœ‰é»˜è®¤é€‰ä¸­çš„å€¼ï¼Œè‡ªåŠ¨æŸ¥è¯¢ä¸€æ¬¡
                setTimeout(() => {
                    if (originSelect.value && destSelect.value) {
                        autoQueryHandler();
                    }
                }, 10);
            }

            init();
        })();
    </script>
</body>
</html>
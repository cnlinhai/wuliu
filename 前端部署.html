<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>å¿«é€’è½¬è¿ Â· äº‘ç«¯å…±äº«ç‰ˆ</title>
    <style>
        /* æ ·å¼ä¸åŸå§‹ç‰ˆæœ¬å®Œå…¨ç›¸åŒï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œè¯·ä¿ç•™åŸæœ‰æ ·å¼ */
        /* ä¸ºä¿æŒå®Œæ•´ï¼Œå»ºè®®ç›´æ¥å¤åˆ¶æ‚¨åŸæœ‰æ ·å¼éƒ¨åˆ† */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f2f7fb; padding: 16px; }
        .app-container { max-width: 600px; margin: 0 auto; }
        h1 { font-size: 1.75rem; border-left: 6px solid #2a9d8f; padding-left: 16px; }
        /* ... å…¶ä½™æ ·å¼ä¸å˜ï¼Œæ­¤å¤„çœç•¥ï¼ˆåŸæœ‰æ ·å¼å‡å¯ä¿ç•™ï¼‰ ... */
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>
            ğŸ“¦ é€Ÿè½¬è¿ 
            <span>äº‘ç«¯å…±äº«</span>
        </h1>

        <div class="flex-row">
            <!-- å¿«é€’å‘˜æŸ¥è¯¢å•å…ƒï¼ˆä¿æŒä¸å˜ï¼Œä»…æ•°æ®æ¥æºå˜åŒ–ï¼‰ -->
            <div class="card">
                <h2>ğŸ” å¿«é€’å‘˜æŸ¥è¯¢</h2>
                <div class="query-area">
                    <div class="auto-query-tip">âš¡ å¿«é€Ÿé€‰æ‹©ï¼šä¸‹æ‹‰é€‰ç‚¹åè‡ªåŠ¨åŒ¹é…</div>
                    <div class="select-row">
                        <select id="originSelect"><option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option></select>
                        <select id="destSelect"><option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option></select>
                        <button id="queryBtn" class="btn btn-primary">ğŸ” ä¸‹æ‹‰æŸ¥è¯¢</button>
                    </div>
                    <div class="manual-row">
                        <div class="manual-title">æ‰‹åŠ¨è¾“å…¥ç›®çš„åœ°ï¼ˆè‡ªåŠ¨æŸ¥è¯¢ï¼‰</div>
                        <div class="input-row">
                            <input type="text" id="manualOrigin" placeholder="è¾“å…¥å‘ä»¶åœ°ï¼ˆå¦‚ï¼šæ·±åœ³ï¼‰">
                            <input type="text" id="manualDest" placeholder="è¾“å…¥æ”¶ä»¶åœ°ï¼ˆå¦‚ï¼šå—äº¬ï¼‰">
                        </div>
                        <button id="manualQueryBtn" class="btn btn-manual-query">âœï¸ æ‰‹åŠ¨æŸ¥è¯¢</button>
                    </div>
                    <div class="result-box">
                        <div class="result-title">
                            <span>ğŸšš åŒ¹é…è½¬è¿ç«™</span>
                            <span id="resultCount" style="background: #2a9d8f20; padding: 5px 16px; border-radius: 40px;">0</span>
                        </div>
                        <div id="resultList"><div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div></div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†è½¬è¿ç«™å•å…ƒï¼ˆä¿æŒä¸å˜ï¼‰ -->
            <div class="card">
                <h2>âš™ï¸ ç®¡ç†è½¬è¿ç«™</h2>
                <div class="btn-group">
                    <label for="importFile" class="btn btn-outline">ğŸ“‚ å¯¼å…¥æ›¿æ¢</label>
                    <input type="file" id="importFile" class="file-input" accept=".csv, text/csv, text/plain">
                    <button id="exportBtn" class="btn btn-outline">â¬‡ï¸ å¯¼å‡ºCSV</button>
                    <label for="updateFile" class="btn btn-primary">ğŸ”„ ä¸Šä¼ æ›´æ–°</label>
                    <input type="file" id="updateFile" class="file-input" accept=".csv, text/csv, text/plain">
                </div>
                <div class="encoding-tip">
                    ğŸ’¡ å¯¼å…¥é»˜è®¤GB2312/GBKï¼›å¯¼å‡ºUTF-8+BOMã€‚<br>
                    ğŸ”„ æ‰€æœ‰æ•°æ®äº‘ç«¯å­˜å‚¨ï¼Œå¤šç”¨æˆ·å…±äº«ã€‚
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>ğŸš© è½¬è¿ç«™åç§°</label>
                        <input type="text" id="newStationName" placeholder="ä¾‹ï¼šä¸Šæµ·æµ¦ä¸œè¥¿">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“¤ å‘ä»¶ç›®çš„åœ°</label>
                        <input type="text" id="newOrigin" placeholder="åŸå¸‚/åŒºåŸŸ">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“¥ æ”¶ä»¶ç›®çš„åœ°</label>
                        <input type="text" id="newDest" placeholder="åŸå¸‚/åŒºåŸŸ">
                    </div>
                    <button id="addRecordBtn" class="btn btn-primary" style="width:100%;">â• æ·»åŠ æ­¤è·¯çº¿</button>
                </div>

                <div class="section-header">
                    <span style="font-weight:700;">ğŸ“‹ å½“å‰è½¬è¿è¡¨</span>
                    <span id="recordCount" class="stats">0 æ¡</span>
                </div>
                <div class="table-responsive">
                    <table id="stationTable">
                        <thead><tr><th>è½¬è¿ç«™</th><th>å‘ä»¶åœ°</th><th>æ”¶ä»¶åœ°</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer-note">
            ğŸ“± äº‘ç«¯å…±äº«ç‰ˆ Â· æ•°æ®å­˜å‚¨äº Cloudflare KV
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ========== é…ç½® ==========
            const API_BASE = 'https://express-transfer-api.xxxx.workers.dev/api';  // âš ï¸ æ›¿æ¢ä¸ºæ‚¨çš„ Worker åŸŸå
            const STORAGE_KEY = 'transit_stations_backup';  // æœ¬åœ°å¤‡ä»½ï¼Œå¯é€‰

            // é»˜è®¤æ•°æ®ï¼ˆä¸ Worker ä¸­çš„ DEFAULT_STATIONS ä¿æŒä¸€è‡´ï¼‰
            const DEFAULT_STATIONS = [
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "åŒ—äº¬" },
                { station: "ä¸Šæµ·æµ¦ä¸œè¥¿è½¬è¿ä¸­å¿ƒ", origin: "ä¸Šæµ·", destination: "å¹¿å·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "ä¸Šæµ·" },
                { station: "åŒ—äº¬å¤§å…´è½¬è¿æ¢çº½", origin: "åŒ—äº¬", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "æˆéƒ½" },
                { station: "å¹¿å·ç™½äº‘é›†æ•£ç«™", origin: "å¹¿å·", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "è¥¿å®‰" },
                { station: "æ­¦æ±‰åä¸­è½¬è¿ä»“", origin: "æ­¦æ±‰", destination: "å—äº¬" },
                { station: "æˆéƒ½é’ç™½æ±Ÿä¸­è½¬ç«™", origin: "æˆéƒ½", destination: "åŒ—äº¬" },
                { station: "è¥¿å®‰é™†æ¸¯è½¬è¿åœº", origin: "è¥¿å®‰", destination: "å…°å·" }
            ];

            let stations = [];

            // DOM å…ƒç´ 
            const tableBody = document.getElementById('tableBody');
            const originSelect = document.getElementById('originSelect');
            const destSelect = document.getElementById('destSelect');
            const queryBtn = document.getElementById('queryBtn');
            const manualOrigin = document.getElementById('manualOrigin');
            const manualDest = document.getElementById('manualDest');
            const manualQueryBtn = document.getElementById('manualQueryBtn');
            const resultList = document.getElementById('resultList');
            const resultCount = document.getElementById('resultCount');
            const recordCountSpan = document.getElementById('recordCount');
            const newStationName = document.getElementById('newStationName');
            const newOrigin = document.getElementById('newOrigin');
            const newDest = document.getElementById('newDest');
            const addRecordBtn = document.getElementById('addRecordBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            const updateFile = document.getElementById('updateFile');

            // ========== API äº¤äº’ ==========
            async function loadFromAPI() {
                try {
                    const response = await fetch(`${API_BASE}/stations`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('ä» API åŠ è½½å¤±è´¥', error);
                    // é™çº§ï¼šå°è¯•ä» localStorage è¯»å–å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
                    const backup = localStorage.getItem(STORAGE_KEY);
                    if (backup) {
                        try {
                            const parsed = JSON.parse(backup);
                            if (Array.isArray(parsed)) return parsed;
                        } catch (e) {}
                    }
                    return null; // æ— æ•°æ®
                }
            }

            async function saveToAPI(data) {
                try {
                    const response = await fetch(`${API_BASE}/stations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    // åŒæ—¶å¤‡ä»½åˆ° localStorage
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜åˆ° API å¤±è´¥', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œæ•°æ®æœªä¿å­˜åˆ°äº‘ç«¯ï¼Œä½†å·²å¤‡ä»½åˆ°æœ¬åœ°');
                    // ä»ç„¶ä¿å­˜åˆ° localStorage ä½œä¸ºæœ¬åœ°å¤‡ä»½
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return false;
                }
            }

            // åˆå§‹åŒ–åŠ è½½æ•°æ®
            async function loadStations() {
                const data = await loadFromAPI();
                if (data && Array.isArray(data)) {
                    stations = data;
                } else {
                    // å¦‚æœ API å®Œå…¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®å¹¶å°è¯•åˆå§‹åŒ– API
                    stations = [...DEFAULT_STATIONS];
                    await saveToAPI(stations);  // å°è¯•å†™å…¥ API
                }
                return stations;
            }

            // ä¿å­˜æ•°æ®ï¼ˆå¹¶åˆ·æ–° UIï¼‰
            async function saveStationsAndRefresh() {
                await saveToAPI(stations);
                refreshUI();  // åˆ·æ–°ä¸‹æ‹‰æ¡†ã€è¡¨æ ¼ã€è®¡æ•°ç­‰
            }

            // ========== UI æ¸²æŸ“ ==========
            function renderTable() {
                if (!tableBody) return;
                if (stations.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px;">ğŸ“­ æš‚æ— æ•°æ®</td></tr>`;
                    return;
                }
                let html = '';
                stations.forEach((item, index) => {
                    html += `<tr>
                        <td style="font-weight:600;">${escapeHtml(item.station)}</td>
                        <td>${escapeHtml(item.origin)}</td>
                        <td>${escapeHtml(item.destination)}</td>
                        <td><button class="delete-btn" data-index="${index}">åˆ é™¤</button></td>
                    </tr>`;
                });
                tableBody.innerHTML = html;
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'), 10);
                        if (!isNaN(index) && index >= 0 && index < stations.length) {
                            stations.splice(index, 1);
                            await saveStationsAndRefresh();  // ä¿å­˜å¹¶åˆ·æ–°
                        }
                    });
                });
            }

            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function updateRecordCount() {
                if (recordCountSpan) recordCountSpan.innerText = `${stations.length} æ¡`;
            }

            function renderDropdowns() {
                if (!originSelect || !destSelect) return;
                const origins = [...new Set(stations.map(s => s.origin).filter(Boolean))].sort();
                const destinations = [...new Set(stations.map(s => s.destination).filter(Boolean))].sort();

                const oldOrigin = originSelect.value;
                const oldDest = destSelect.value;

                originSelect.innerHTML = `<option value="" disabled selected>â€” å‘ä»¶ç›®çš„åœ° â€”</option>` +
                    origins.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
                destSelect.innerHTML = `<option value="" disabled selected>â€” æ”¶ä»¶ç›®çš„åœ° â€”</option>` +
                    destinations.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

                if (origins.includes(oldOrigin)) originSelect.value = oldOrigin;
                if (destinations.includes(oldDest)) destSelect.value = oldDest;
            }

            function clearQueryResult() {
                resultList.innerHTML = `<div class="empty-msg">ğŸ‘† è¯·é€‰æ‹©æˆ–è¾“å…¥åœ°ç‚¹ï¼Œè‡ªåŠ¨åŒ¹é…</div>`;
                resultCount.innerText = '0';
            }

            function queryTransitStation(origin, dest) {
                if (!origin || !dest) {
                    clearQueryResult();
                    return;
                }
                const matched = stations.filter(item => item.origin === origin && item.destination === dest);
                if (matched.length === 0) {
                    resultList.innerHTML = `<div class="empty-msg">ğŸš« æ— åŒ¹é…è½¬è¿ç«™<br><span style="font-size:0.85rem;">${escapeHtml(origin)} â†’ ${escapeHtml(dest)}</span></div>`;
                    resultCount.innerText = '0';
                } else {
                    let html = '';
                    matched.forEach(item => {
                        html += `<div class="transit-card">
                            <span class="transit-name">ğŸš› ${escapeHtml(item.station)}</span>
                            <span class="badge">${escapeHtml(item.origin)}</span>
                            <span style="color: #2a9d8f;">â†’</span>
                            <span class="badge">${escapeHtml(item.destination)}</span>
                        </div>`;
                    });
                    resultList.innerHTML = html;
                    resultCount.innerText = `${matched.length}`;
                }
            }

            function refreshUI() {
                renderTable();
                renderDropdowns();
                updateRecordCount();
                clearQueryResult();  // æŸ¥è¯¢ç»“æœæ¸…ç©ºï¼Œé¿å…æ˜¾ç¤ºæ—§æ•°æ®
            }

            // ========== äº‹ä»¶ç»‘å®š ==========
            function bindEvents() {
                queryBtn.addEventListener('click', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });
                originSelect.addEventListener('change', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });
                destSelect.addEventListener('change', () => {
                    queryTransitStation(originSelect.value, destSelect.value);
                });

                manualQueryBtn.addEventListener('click', () => {
                    const origin = manualOrigin.value.trim();
                    const dest = manualDest.value.trim();
                    if (origin && dest) queryTransitStation(origin, dest);
                    else alert('è¯·å®Œæ•´å¡«å†™å‘ä»¶åœ°å’Œæ”¶ä»¶åœ°');
                });

                // æ·»åŠ è®°å½•
                addRecordBtn.addEventListener('click', async function() {
                    const station = newStationName.value.trim();
                    const origin = newOrigin.value.trim();
                    const dest = newDest.value.trim();
                    if (!station || !origin || !dest) {
                        alert('è½¬è¿ç«™ã€å‘ä»¶åœ°ã€æ”¶ä»¶åœ°ä¸èƒ½ä¸ºç©º');
                        return;
                    }
                    stations.push({ station, origin, destination: dest });
                    await saveStationsAndRefresh();
                    newStationName.value = '';
                    newOrigin.value = '';
                    newDest.value = '';
                });

                // å¯¼å‡º CSV
                exportBtn.addEventListener('click', function() {
                    if (stations.length === 0) {
                        alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    let csvContent = "è½¬è¿ç«™,å‘ä»¶ç›®çš„åœ°,æ”¶ä»¶ç›®çš„åœ°\n";
                    stations.forEach(item => {
                        csvContent += `${item.station},${item.origin},${item.destination}\n`;
                    });
                    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è½¬è¿ç«™æ•°æ®_${Date.now()}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                });

                // å¯¼å…¥ CSVï¼ˆæ›¿æ¢ï¼‰
                importFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const content = ev.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) {
                            alert('CSVç¼ºå°‘æ•°æ®è¡Œ');
                            return;
                        }
                        const newStations = [];
                        for (let i = 1; i < lines.length; i++) {
                            const parts = lines[i].split(',').map(s => s.trim());
                            if (parts.length >= 3) {
                                newStations.push({ station: parts[0], origin: parts[1], destination: parts[2] });
                            }
                        }
                        if (newStations.length === 0) {
                            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®');
                            return;
                        }
                        stations = newStations;
                        await saveStationsAndRefresh();
                        alert(`âœ… æˆåŠŸå¯¼å…¥ ${newStations.length} æ¡è®°å½•`);
                        importFile.value = '';
                    };
                    reader.readAsText(file, 'GB2312'); // å¯è°ƒæ•´ç¼–ç ï¼Œä½†ä¿ç•™åŸæœ‰æ™ºèƒ½è§£æè¾ƒå¤æ‚ï¼Œç®€åŒ–ç‰ˆç”¨ GB2312
                });

                // ä¸Šä¼ æ›´æ–°ï¼ˆæ›¿æ¢ï¼‰â€”â€”ä¸å¯¼å…¥ç›¸åŒé€»è¾‘ï¼Œå¯åˆå¹¶ï¼Œä½†ä¿ç•™ä¸¤ä¸ªæŒ‰é’®
                updateFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        // ç®€å•è§£æï¼Œå®é™…å¯ç”¨æ›´æ™ºèƒ½çš„ç¼–ç æ£€æµ‹ï¼Œæ­¤å¤„ç®€åŒ–
                        const content = ev.target.result;
                        const lines = content.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length <= 1) {
                            alert('CSVç¼ºå°‘æ•°æ®è¡Œ');
                            return;
                        }
                        const newStations = [];
                        for (let i = 1; i < lines.length; i++) {
                            const parts = lines[i].split(',').map(s => s.trim());
                            if (parts.length >= 3) {
                                newStations.push({ station: parts[0], origin: parts[1], destination: parts[2] });
                            }
                        }
                        if (newStations.length === 0) {
                            alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®');
                            return;
                        }
                        stations = newStations;
                        await saveStationsAndRefresh();
                        alert(`âœ… æˆåŠŸæ›´æ–° ${newStations.length} æ¡è®°å½•`);
                        updateFile.value = '';
                    };
                    reader.readAsText(file, 'GB2312');
                });
            }

            // åˆå§‹åŒ–
            async function init() {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
                document.body.classList.add('loading');
                await loadStations();
                refreshUI();
                bindEvents();
                document.body.classList.remove('loading');

                // å¦‚æœä¸‹æ‹‰æ¡†æœ‰å€¼ï¼Œè‡ªåŠ¨æŸ¥è¯¢ä¸€æ¬¡
                setTimeout(() => {
                    if (originSelect.value && destSelect.value) {
                        queryTransitStation(originSelect.value, destSelect.value);
                    }
                }, 100);
            }

            init();
        })();
    </script>
</body>
</html>